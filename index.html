<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Retaped</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png"
        href="https://autumn.revolt.chat/attachments/g4v14HHTNuqzrd7Fn_YbZjlK8i6NL1ibajV3gLf2jR/Untitled132_20220310202647.png" />
    <!--<script src="https://js.hcaptcha.com/1/api.js" async defer></script>-->
</head>

<body>
    <h1 id="name">Retaped</h1>
    <h4 id="descri">The revolt.chat client re-taped from the one that's held together by duct tape and bad code</h4>
    <br />
    <div id="loginoe">

        <div id="innercontainer">
            <h4 id="loginerror" hidden="false"></h4>
            <input id="token" type="password" autocomplete="on" placeholder="Token">
            <br><input id="inputTheme" placeholder="Theme">
            <br><button id="login" onclick="login();">Login</button>
        </div>
        <!--
        <div id="innercontainer">
            <input id="email" autocomplete="on" placeholder="Email address">
            <input id="password" autocomplete="on" placeholder="Password" type="password">
            <div class="h-captcha" data-sitekey="3daae85e-09ab-4ff6-9f24-e8f4f335e433"></div>
            <input type="submit" value="Submit"/>
        </div>
    -->
    </div>
    <div id="logged" hidden="true">
        <div id="info">
            <button id="dms" onclick="getdms()">DMS</button>
            <br>
            <br>
            <div id="servers"></div>
        </div>

        <div id="channelInfo">
            <h3 id="connected">Disconnected</h3>
            <h2 id="chanName"></h2>
            <h3 id="chanDesc"></h3>
            <br>
            <div id="channels"></div>
        </div>

        <div id="central">
            <div id="messages" hidden="true">
            </div>
            <button onclick="bonfire()">Re-establish websocket</button>
            <button onclick="getmessage()">Get messages</button>
            <button onclick="uIDs=[];usernames=[];pfpsrcs=[];getmessage();">Reload Usernames</button>
            <button onclick="embedmessage()">Send embed</button>
            <br>
            <input type="text" autocomplete="off" placeholder="Title" id="title" hidden="true" />
            <input type="text" autocomplete="off" placeholder="Description" id="desc" hidden="true" />
            <input type="text" autocomplete="off" placeholder="Color" id="color" hidden="true" />
            <h5 id="error" hidden="true"></h5>
            <h5 id="replymsg" style="display:inline" hidden="true"></h5><button style="display:inline" hidden="true"
                id=closereply onclick="document.getElementById('replymsg').innerText='';reply=''">X</button>
            <input type="file" id="upload"></input>
            <div id="messagebar">
                <button onclick="contentToJson()">JSON</button>
                <input type="text" style="width: 90%;" autocomplete="off" placeholder="Speak in channel" id="input" />
                <button onclick="sendmessage()">Send</button>
            </div>
        </div>
        <h2 id="theme"></h2>
    </div>
    <style>
        * {
            --foreground: #FFFFFF;
            --background: #000000;
            --secondary-background: #1A1A1A;
            --usernames: #FFFFFF;
            --input-color: #000000;
            --accent: #FD6671;
        }

        #loginoe {
            position: absolute;
            top: 50%;
            left: 50%;
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            background-color: var(--secondary-background);
            border-radius: 30px !important;
            height: 20%;
            width: 30%;
            padding: 2px;
            background-image: linear-gradient(to bottom, var(--secondary-background) 0%, var(--secondary-background) 100%), linear-gradient(to bottom, var(--accent) 0%, var(--accent) 100%);
            background-clip: content-box, padding-box;
        }

        #innercontainer {
            position: absolute;
            top: 50%;
            left: 50%;
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }

        #login,
        #inputTheme,
        #token {
            display: block;
            margin-right: auto;
            margin-left: auto;
        }

        #inputTheme,
        #token {
            color: var(--foreground);
            border-radius: 10px;
            line-height: 200%;
            width: 400px;
            outline: 2px solid var(--foreground);
        }

        #upload {
            background-color: var(--background)
        }

        #info {
            display: block;
        }

        #closereply {
            display: none
        }

        [id^=server],
        [id^=chan],
        [id^=dm] {
            width: 15em;
            outline: 0;
            border-color: rgba(0, 0, 0, 0)
        }

        .msg,
        .messagecont {
            word-break: break-all;
            white-space: pre-wrap;
            padding-bottom: 5px;
            max-width: 80% !important;
        }

        #author {
            display: inline-block;
        }

        #input,
        #author {
            color: var(--usernames);
            margin-left: 0%;
            border-left: 0%
        }

        #central {
            display: block;
            flex-direction: column;
            padding-left: 10%;
        }

        #channelInfo {
            padding-left: 2%;
            width: 10%;
            padding-right: 2%;
            word-break: break-all !important;
        }

        #info {
            word-break: break-all !important;
        }

        input {
            background-color: var(--input-color);
        }

        button:hover {
            text-shadow: 0 -1px 0 darken(var(--accent), 15%);
            background: lighten(var(--accent), 5%);
        }

        #logged {
            flex-direction: row;
            align-items: flex-start;
        }

        .messagecont,
        .message {
            text-align: left;
            margin: 0;
            white-space: nowrap;
            display: inline;
            vertical-align: top;
            padding: 0;
        }

        #replymsg {
            padding-bottom: 0px;
            display: block
        }

        #name,
        #descri {
            text-align: center;
            font-family: Arial, Helvetica, sans-serif;
        }

        h6,
        h5,
        h4 {
            margin: 0
        }

        html {
            background-color: var(--background);
            color: var(--foreground);
            font-family: monospace
        }
        img {
            max-width: 600px;
        }

        #messages {
            white-space: pre-line;
            overflow: auto;
            backface-visibility: hidden;
            -ms-overflow-style: none;
            height: 45vw;
            overflow-y: scroll;
        }

        #messagebar {
            display: flex;
            align-items: center;
        }

        #channels {
            border-style: solid;
            border-color: var(--foreground);
            border-width: medium;
            padding-right: 5px;
            border-radius: 5px;
        }

        button {
            background-color: var(--secondary-background);
            color: var(--foreground)
        }

        .pfp {
            max-width: 50px;
            max-width: 50px;
        }
    </style>
    <script>
        let lastmessage;
        let embedSend = false;
        let sendRawJson = false;
        let uIDs = [];
        let usernames = [];
        let thechannel = "";
        let reply = "";
        let image = "";
        let theuser = "";
        let messages = [];
        let pfpsrcs = [];
        let thetoken;
        let tm;
        let socket;
        let typingtimeout;
        let istyping = false;
        let messcont;
        let errortimeout;

        if(localStorage.getItem("token") !=undefined){
                    thetoken=localStorage.getItem("token");
                    login();
        }

        async function login() {
            let theme;
            if (document.getElementById("token").value) {
                thetoken = document.getElementById("token").value;
                    localStorage.setItem("token",thetoken)
            }
            bonfire()
            await fetch("https://api.revolt.chat/users/@me", {
                "credentials": "omit",
                "headers": {
                    "Accept": "*/*",
                    "x-session-token": thetoken
                },
                "method": "GET"
            })
                .then(response => response.json())
                .then(data => theuser = data)
                .catch(err => showError("INVALID TOKEN"))
            document.getElementById("loginoe").hidden = true;
            document.getElementById("logged").hidden = false;
            document.getElementById("logged").style = "display:flex;"
            document.getElementById("name").hidden = true;
            document.getElementById("descri").hidden = true;
            //if (!document.getElementById("inputTheme").value == '') { document.cookie = `theme=${document.getElementById("inputTheme").value};` }
            //if (document.cookie) { let theme = document.cookie.split('; ').find(row => row.startsWith('theme=')).split('=')[1]; }
            theme = document.getElementById("inputTheme").value
            document.getElementById("theme").innerHTML = theme;
        }

        async function bonfire() {
            socket = new WebSocket("wss://ws.revolt.chat");
            socket.addEventListener('open', function (event) {
                socket.send(`{
                    "type": "Authenticate",
                    "token": "${thetoken}"
                }`);
                try {
                    setInterval(ping, 10000);
                } catch (error) { showError(error) }
            });

            socket.addEventListener('message', function (event) {
                data = JSON.parse(event.data)
                if (data.type == "Authenticated") {
                    document.getElementById("connected").innerText = "Connected"
                } else if (data.type == "Message") {
                    if (data.channel == thechannel) {
                        parsemessage(data);
                    }
                } else if (data.type == "Pong") {
                    pong()
                } else if (data.type == "Error") {
                    if (data.error == "InvalidSession") { showError("INVALID TOKEN"); } else { showError(data.error); }
                } else if (data.type == "Ready") {
                    console.log(JSON.stringify(data.servers))
                    getserver(data.servers);
                }
            });

            socket.addEventListener('error', function (event) {
                document.getElementById("connected").innerText = "Disconnected"
                showError("Disconnected")
            });

            socket.onclose = function (event) {
                document.getElementById("connected").innerText = "Disconnected";
                showError("Disconnected")
            }
        }

        function ping() {
            socket.send('{"type":"Ping","data":0}');
            tm = setTimeout(async function () {
                document.getElementById("connected").innerText = "Disconnected";
                showError("Disconnected")
                while (document.getElementById("connected") == "Disconnected") {
                    try { bonfire(); } catch (error) { showError(error) }
                    await sleep(5000);
                }
            }, 5000);
        }

        function pong() {
            clearTimeout(tm);
        }

        async function showError(error) {
            try { clearTimeout(errortimeout); } catch (error) { }
            document.getElementById("loginerror").innerText = error;
            document.getElementById("error").innerText = error;
            document.getElementById("loginerror").hidden = false;
            document.getElementById("error").hidden = false;
            errortimeout = setTimeout(function () {
                document.getElementById('error').hidden = true;
                document.getElementById('loginerror').hidden = true;
            }, 10000);
        }

        async function uploadToAutumn() {
            const files = document.getElementById("upload").files
            const formData = new FormData()
            formData.append('myFile', files[0])

            await fetch('https://autumn.revolt.chat/attachments', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    image = data.id;
                })
                .catch(error => {
                    showError(error)
                })
        }

        function embedmessage() {
            document.getElementById("title").hidden = false;
            document.getElementById("desc").hidden = false;
            document.getElementById("color").hidden = false;
            embedSend = true;
        }


        document.getElementById("input").onkeypress = function (event) {
            if (event.keyCode == 13 || event.which == 13) {
                sendmessage();
            } else {
                if (!istyping) {
                    clearTimeout(typingtimeout);
                    istyping = true
                    socket.send(`{
                        "type":"BeginTyping",
                        "channel":"${thechannel}"
                        }`);

                    typingtimeout = setTimeout(function () {
                        istyping = false;
                        socket.send(`{
                            "type":"EndTyping",
                            "channel":"${thechannel}"
                        }`);
                    }, 1000)
                }
            }
        };



        function contentToJson() {
            sendRawJson = sendRawJson ? false : true
        }


        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }


        async function sendmessage() {
            message = document.getElementById('input').value
            if (message.search(/ @[^ ]*/) != -1) {
                pings = /@[^ ]*/[Symbol.match](message)
                for (let i = 0; i < pings.length; i++) {
                    message = message.replace(pings[i], `<@${uIDs[usernames.indexOf(pings[i].replace("@", ""))]}>`)
                }
            }
            if (!(embedSend || sendRawJson || reply != "" || document.getElementById("upload").files[0])) {
                fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                    "credentials": "omit",
                    "headers": {
                        "Accept": "*/*",
                        "Content-Type": "application/json",
                        "x-session-token": thetoken
                    },
                    "body": `{
                    "content":"${message}"
                }`,
                    "method": "POST"
                })
                document.getElementById("input").value = ""
            }
            else {
                if (reply != "") {
                    fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                        "credentials": "omit",
                        "headers": {
                            "Accept": "*/*",
                            "Content-Type": "application/json",
                            "x-session-token": thetoken
                        },
                        "body": `{
                    "content":"${message}",
                    "replies":[{"id":"${reply}","mention":false}]
                }`,
                        "method": "POST"
                    })
                    document.getElementById("input").value = "";
                    reply = ""
                    document.getElementById('replymsg').innerText = '';
                    document.getElementById('replymsg').hidden = true
                } else {
                    if (document.getElementById("upload").files[0]) {
                        await uploadToAutumn();
                        await fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                            "credentials": "omit",
                            "headers": {
                                "Accept": "*/*",
                                "Content-Type": "application/json",
                                "x-session-token": thetoken
                            },
                            "body": `{
                    "content":"${message}",
                    "attachments":["${image}"]
                }`,
                            "method": "POST"
                        })
                        var file = document.getElementById("upload");
                        file.value = file.defaultValue;
                        image = ""
                        document.getElementById("input").value = ""
                    } else {
                        if (embedSend) {
                            fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                                "credentials": "omit",
                                "headers": {
                                    "Accept": "*/*",
                                    "Content-Type": "application/json",
                                    "x-session-token": thetoken
                                },
                                "body": `{
                    "nonce":"",
                    "content":"${message}",
                    "embeds":[
                        {
                            "title":"${document.getElementById("title").value}",
                            "description":"${document.getElementById("desc").value}",
                            "colour":"${document.getElementById("color").value}"
                        }
                    ]
                }`,
                                "method": "POST"
                            })
                            embedSend = false;
                            document.getElementById("title").hidden = true;
                            document.getElementById("desc").hidden = true;
                            document.getElementById("color").hidden = true;
                            document.getElementById("title").value = "";
                            document.getElementById("desc").value = "";
                            document.getElementById("color").value = "";
                        }
                        else {
                            fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                                "credentials": "omit",
                                "headers": {
                                    "Accept": "*/*",
                                    "Content-Type": "application/json",
                                    "x-session-token": thetoken
                                },
                                "body": document.getElementById("input").value,
                                "method": "POST"
                            })
                            sendRawJson = false;
                        }
                    }
                }
            }
        }

        function clearmessages() {
            messages = [];
            document.getElementById('messages').innerHTML = '';
            messcont = [];
        }

        async function getdms() {
            await fetch(`https://api.revolt.chat/users/dms`, {
                "credentials": "omit",
                "headers": {
                    "Accept": "*/*",
                    "x-session-token": thetoken
                },
                "method": "GET",
            })
                .then(response => response.json())
                .then(data => dm = (data))
                .catch(error => { showError(error) });
            document.getElementById('channels').innerHTML = "";
            for (let i = 0; i < dm.length; i++) {
                try {
                    if (dm[i].channel_type == "Group") {
                        document.getElementById('channels').innerHTML = `<button onclick="
                        theserver='';
                        clearmessages();
                        thechannel = '${dm[i]._id}';
                        getmessage()"
                        id="dm${i}">${dm[i]["name"]}</button>`
                            + document.getElementById('channels').innerHTML
                    } else {
                        if (dm[i].recipients[0] == theuser._id) {
                            id = dm[i].recipients[1]
                        } else {
                            id = dm[i].recipients[0]
                        }
                        document.getElementById('channels').innerHTML = `<button onclick="
                        theserver='';
                        clearmessages();
                        thechannel = '${dm[i]._id}';
                        getmessage()"
                        id="dm${i}">${id}</button>`
                            + document.getElementById('channels').innerHTML

                        fetch("https://api.revolt.chat/users/" + id, {
                            "credentials": "omit",
                            "headers": {
                                "Accept": "*/*",
                                "x-session-token": thetoken
                            },
                            "method": "GET",
                        }).then(response => response.json())
                            .then(data => document.getElementById(`dm${i}`).innerText = (data.username))
                    }
                } catch (error) {
                    showError(error)
                }
            }
        }

        async function getserver(server) {

            for (let i = 1; i < server.length; i++) {
                document.getElementById(`servers`).innerHTML +=
                    `<button onclick="theserver = '${server[i - 1]._id}';getchannel()"
                id="server${i}">${server[i - 1].name}</button>`;
            }
        }


        async function getchannel() {
            document.getElementById(`channels`).innerHTML = ""
            await fetch(`https://api.revolt.chat/servers/${theserver}/`, {
                "credentials": "omit",
                "headers": {
                    "Accept": "*/*",
                    "x-session-token": thetoken
                },
                "method": "GET",
            }).then(response => response.json())
                .then(data => chann = (data.channels))
            for (let i = 0; i < chann.length; i++) {
                document.getElementById(`channels`).innerHTML += `<button onclick="
                thechannel = '${chann[i]}';
                clearmessages();
                getmessage();"
                id="chann${i}">${chann[i]}</button>`;
            }
            for (let i = 0; i < chann.length; i++) {
                fetch(`https://api.revolt.chat/channels/${chann[i]}/`, {
                    "credentials": "omit",
                    "headers": {
                        "Accept": "*/*",
                        "x-session-token": thetoken
                    },
                    "method": "GET",
                }).then(response => response.json())
                    .then(data => {
                        if (data.channel_type === "VoiceChannel") {
                            document.getElementById(`chann${i}`).remove(); return;
                        }
                        document.getElementById(`chann${i}`).innerText = data.name
                    });
            }
        }

        async function parsemessage(message) {
            try {
                let pfpsrc = ""
                let username = ""
                let img = ""
                let replyinmsg = ""
                if (message.attachments) {
                    image = message.attachments;
                    img = `<br><img src="https://autumn.revolt.chat/attachments/${image[0]._id}/${image[0].filename}">`
                }
                if (message.replies) {
                    if (messages.indexOf(!message.replies[0]._id) == -1) {
                        await fetch(`https://api.revolt.chat/channels/${thechannel}/messages/${message.replies[0]}`, {
                            "credentials": "omit",
                            "headers": {
                                "Accept": "*/*",
                                "x-session-token": thetoken
                            },
                            "method": "GET",
                        }).then(response => response.json())
                            .then(data => replyinmsg = ("> " + data.content))
                    } else {
                        replyinmsg = "> " + messcont[messages.indexOf(message.replies[0])]
                    }
                }
                if (message.masquerade) {
                    try {
                        username = message.masquerade.name;
                        pfpsrc = message.masquerade.avatar;
                    } catch (error) { showError(JSON.stringify(message) + error) }
                } else if (uIDs.indexOf(message.author) === -1) {
                    await fetch(`https://api.revolt.chat/users/${message.author}`, {
                        "credentials": "omit",
                        "headers": {
                            "Accept": "*/*",
                            "x-session-token": thetoken,
                            "Cache-Control": "private"
                        },
                        "method": "GET",
                    }).then(response => response.json())
                        .then(data => {
                            if (data.avatar) {
                                pfpsrc = `https://autumn.revolt.chat/avatars/${data.avatar._id}/${data.avatar.filename}`;
                            }
                            else {
                                pfpsrc = `https://api.revolt.chat/users/${message.author}/default_avatar`
                            }
                            username = data.username
                            pfpsrcs.push(pfpsrc)
                            usernames.push(data.username)
                            uIDs.push(data._id)
                        });
                } else {
                    pfpsrc = pfpsrcs[uIDs.indexOf(message.author)]
                    username = usernames[uIDs.indexOf(message.author)]
                }
                if(message.reactions){
                    console.log(message.reactions)
                    for(let i=0;i<message.reactions.length;i++){
                        console.log(message.reactions[i])
                    }
                }
                document.getElementById("messages").innerHTML = document.getElementById("messages").innerHTML + `
                <div class="messagecont" onclick="button=document.getElementById('reply${message._id}'); if(button.hidden){button.hidden=false}else{button.hidden=true}">
                    <h6 hidden="${replymsg != "" ? "true" : "false"}" id="replymsg">${replyinmsg}</h6>
                    <div class="message">
                        ${lastmessage != message.author ? `<img src="${pfpsrc}" class="pfp"></img>
                        <h4 id="author">${username}</h4>` : ""}
                        <button hidden=true class="reply" id="reply${message._id}" onclick="
                        reply='${message._id}';
                        document.getElementById('replymsg').innerText='> ${message.content}';
                        document.getElementById('replymsg').hidden=false">
                            reply</button>
                        <h5 class="msg">${message.content}${img}</h5>
                    </div>
                </div>`
                messages.push(message._id);
                messcont.push(message.content)
                lastmessage = message.author
            } catch (error) { showError(error) }
        }

        async function getmessage() {
            fetch(`https://api.revolt.chat/channels/${thechannel}`, {
                "credentials": "omit",
                "headers": {
                    "Accept": "*/*",
                    "x-session-token": thetoken
                },
                "method": "GET",
            }).then(response => response.json())
                .then(data => {
                    if (data.channel_type == "DirectMessage") { document.getElementById("chanName").innerText = data.recipients[0] } else { document.getElementById("chanName").innerText = data.name; }
                    if (data.description) { document.getElementById("chanDesc").innerText = data.description };
                })

            document.getElementById("messages").hidden = false;
            document.getElementById("messages").innerHTML = "";
            await fetch(`https://api.revolt.chat/channels/${thechannel}/messages?include_users=true`, {
                "credentials": "omit",
                "headers": {
                    "Accept": "*/*",
                    "x-session-token": thetoken
                },
                "method": "GET",
            }).then(response => response.json())
                .then(data => {mess = (data.messages); users = (data.users)})
            
            for(let i=0;i<users.length;i++){
                console.log(users[i])
                if(uIDs.indexOf(users[i]._id) === -1){
                    uIDs.push(users[i]._id)
                    usernames.push(users[i].username)
                    if(users[i].avatar){
                        pfpsrcs.push(`https://autumn.revolt.chat/avatars/${users[i].avatar._id}/${users[i].avatar.filename}`)
                    } else {
                        pfpsrcs.push(`https://autumn.revolt.chat/avatars/${users[i]._id}/default_avatar`)
                    }
                }
            }
            mess.reverse()
            for (let i = 1; i <= mess.length; i++) {
                await parsemessage(mess[i - 1])
            }
        }
    </script>
</body>

</html>
